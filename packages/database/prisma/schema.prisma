// Lions Event Management Hub - Prisma Schema
// Multi-tenant event management system for Lions Clubs

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// Enums
// ============================================

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
}

enum MemberRole {
  ADMIN
  BOARD
  MEMBER
  GUEST
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum EventType {
  REGULAR_MEETING
  BOARD_MEETING
  GENERAL_ASSEMBLY
  ACTIVITY
  FUNDRAISING
  SOCIAL
  DISTRICT
  INTERNATIONAL
  OTHER
}

enum EventVisibility {
  PUBLIC
  MEMBERS
  BOARD
}

enum RegistrationStatus {
  REGISTERED
  CANCELLED
  MAYBE
  WAITLIST
  NO_RESPONSE
}

enum LionsYearStatus {
  DRAFT
  PLANNING
  ACTIVE
  ARCHIVED
}

enum PlannedEventStatus {
  PLANNED
  CONFIRMED
  CANCELLED
}

enum RecurringFrequency {
  WEEKLY
  MONTHLY
}

// ============================================
// Models
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  slug      String   @unique // for subdomain (e.g., "lions-zurich")
  name      String
  clerkOrgId String? @unique
  clubNumber String  @unique // Lions Club Nummer (z.B. "123456")

  // Branding
  logo         String? // URL to logo image
  primaryColor String  @default("#00338D") // Lions blue
  accentColor  String  @default("#EBB700") // Lions gold

  // Contact information
  email   String?
  phone   String?
  website String?
  address String? @db.Text

  // Website configuration
  websiteEnabled   Boolean @default(false)
  websiteTitle     String?
  websiteLogo      String? // URL zum Logo
  heroImage        String? // URL zum Hero-Bild
  heroText         String? @db.Text
  aboutText        String? @db.Text // Über uns Text
  contactEmail     String?
  contactPhone     String?
  contactAddress   String? @db.Text
  socialFacebook   String? // Facebook-URL
  socialInstagram  String? // Instagram-URL
  socialLinkedin   String? // LinkedIn-URL

  // Settings & Features
  settings Json    @default("{}")
  features String[] @default([])

  // Subscription
  plan          SubscriptionPlan @default(FREE)
  planExpiresAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members            Member[]
  events             Event[]
  activityTypes      ActivityType[]
  eventRegistrations EventRegistration[]
  eventAttachments   EventAttachment[]
  eventCategories    EventCategory[]
  eventTemplates     EventTemplate[]
  recurringRules     RecurringRule[]
  lionsYears         LionsYear[]

  @@index([slug])
  @@index([clerkOrgId])
  @@map("tenants")
}

model Member {
  id          String   @id @default(cuid())
  tenantId    String
  clerkUserId String

  // Profile
  firstName String
  lastName  String
  email     String
  phone     String?
  avatarUrl String?

  // Lions-specific
  memberNumber String? // Club membership number
  joinDate     DateTime?
  sponsor      String? // Name of sponsor member

  // Role & Status
  role   MemberRole   @default(MEMBER)
  status MemberStatus @default(PENDING)

  // Preferences
  locale             String  @default("de") // de or en
  emailNotifications Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdEvents      Event[]
  eventRegistrations EventRegistration[]

  @@unique([tenantId, clerkUserId])
  @@index([tenantId])
  @@index([clerkUserId])
  @@index([email])
  @@index([status])
  @@map("members")
}

model ActivityType {
  id       String @id @default(cuid())
  tenantId String

  // Names
  name   String
  nameEn String?

  // Styling
  color String @default("#00338D")
  icon  String? // Icon identifier (e.g., "calendar", "trophy")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  events Event[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("activity_types")
}

model Event {
  id       String @id @default(cuid())
  tenantId String

  // Basic information
  title       String
  titleEn     String?
  description String  @db.Text
  descriptionEn String? @db.Text

  // Classification
  type           EventType @default(ACTIVITY)
  categoryId     String?

  // Location
  location    String?
  locationUrl String?
  isOnline    Boolean @default(false)
  onlineUrl   String?

  // Date & Time
  startDate DateTime
  endDate   DateTime?
  allDay    Boolean  @default(false)

  // Registration
  registrationRequired Boolean   @default(true)
  registrationDeadline DateTime?
  maxParticipants      Int?
  allowGuests          Boolean   @default(true)
  maxGuestsPerMember   Int       @default(2)

  // Cost
  costMember Decimal @default(0) @db.Decimal(10, 2)
  costGuest  Decimal @default(0) @db.Decimal(10, 2)

  // Visibility & Status
  visibility  EventVisibility @default(MEMBERS)
  isPublished Boolean         @default(false)
  isCancelled Boolean         @default(false)
  isPublic    Boolean         @default(false) // Sichtbar auf öffentlicher Club-Website

  // Reminders
  reminderDays Int[] @default([7, 3, 1]) // Days before event to send reminders

  // Creator
  createdById String

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category      ActivityType?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  createdBy     Member              @relation(fields: [createdById], references: [id])
  registrations EventRegistration[]
  attachments   EventAttachment[]
  plannedEvents PlannedEvent[]      // Events created from planned events

  @@index([tenantId])
  @@index([categoryId])
  @@index([createdById])
  @@index([startDate])
  @@index([type])
  @@index([visibility])
  @@index([isPublished])
  @@map("events")
}

model EventRegistration {
  id       String @id @default(cuid())
  tenantId String
  eventId  String
  memberId String

  // Registration status
  status RegistrationStatus @default(REGISTERED)

  // Guests
  guestCount Int      @default(0)
  guestNames String[] @default([])
  comment    String?  @db.Text
  dietaryNotes String? @db.Text

  // Payment
  totalCost Decimal   @default(0) @db.Decimal(10, 2)
  isPaid    Boolean   @default(false)
  paidAt    DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([eventId, memberId])
  @@index([tenantId])
  @@index([eventId])
  @@index([memberId])
  @@index([status])
  @@map("event_registrations")
}

model EventAttachment {
  id       String @id @default(cuid())
  tenantId String
  eventId  String

  // File information
  fileName String
  fileUrl  String
  fileType String
  fileSize Int // in bytes

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([eventId])
  @@map("event_attachments")
}

// ============================================
// Lions Year Planning Models
// ============================================

model EventCategory {
  id        String  @id @default(cuid())
  tenantId  String
  name      String // z.B. "Clubabend", "Activity", "Versammlung"
  color     String? // Hex-Farbe für Kalender
  icon      String? // Icon-Name
  isDefault Boolean @default(false) // vordefinierte Kategorie
  sortOrder Int     @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  templates     EventTemplate[]
  recurringRules RecurringRule[]
  plannedEvents PlannedEvent[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([sortOrder])
  @@map("event_categories")
}

model EventTemplate {
  id                    String  @id @default(cuid())
  tenantId              String
  categoryId            String
  name                  String // z.B. "Mitgliederversammlung", "Bobby Car Rennen"
  description           String? @db.Text
  defaultInvitationText String? @db.Text // Text für Einladungen
  isMandatory           Boolean @default(false) // Pflichttermin
  defaultMonth          Int? // 1-12, Monat in dem Termin normalerweise stattfindet
  defaultDurationMinutes Int    @default(120)
  isActive              Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category      EventCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  plannedEvents PlannedEvent[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([categoryId])
  @@map("event_templates")
}

model RecurringRule {
  id                String             @id @default(cuid())
  tenantId          String
  name              String // z.B. "Erster Dienstag", "Letzter Donnerstag"
  description       String?
  frequency         RecurringFrequency @default(MONTHLY)
  dayOfWeek         Int // 0=Sonntag, 1=Montag, ..., 6=Samstag
  weekOfMonth       Int? // 1=erste, 2=zweite, -1=letzte Woche
  defaultCategoryId String?
  defaultTitle      String? // z.B. "Clubabend"
  isActive          Boolean            @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  defaultCategory EventCategory? @relation(fields: [defaultCategoryId], references: [id], onDelete: SetNull)
  plannedEvents   PlannedEvent[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([defaultCategoryId])
  @@map("recurring_rules")
}

model LionsYear {
  id         String          @id @default(cuid())
  tenantId   String
  name       String // z.B. "Lionsjahr 2024/2025"
  startDate  DateTime
  endDate    DateTime
  status     LionsYearStatus @default(DRAFT)
  isArchived Boolean         @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plannedEvents PlannedEvent[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([status])
  @@map("lions_years")
}

model PlannedEvent {
  id               String             @id @default(cuid())
  lionsYearId      String
  templateId       String?
  recurringRuleId  String?
  categoryId       String
  publishedEventId String?            // Reference to Event when published
  date             DateTime
  endDate          DateTime?
  title            String
  description      String?            @db.Text
  invitationText   String?            @db.Text
  status           PlannedEventStatus @default(PLANNED)
  isMandatory      Boolean            @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lionsYear      LionsYear      @relation(fields: [lionsYearId], references: [id], onDelete: Cascade)
  template       EventTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  recurringRule  RecurringRule? @relation(fields: [recurringRuleId], references: [id], onDelete: SetNull)
  category       EventCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  publishedEvent Event?         @relation(fields: [publishedEventId], references: [id], onDelete: SetNull)

  @@index([lionsYearId])
  @@index([templateId])
  @@index([recurringRuleId])
  @@index([categoryId])
  @@index([publishedEventId])
  @@index([date])
  @@index([status])
  @@map("planned_events")
}
